<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Deadline Manager</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --tg-theme-bg-color:#1a1a1a;--tg-theme-text-color:#ffffff;--tg-theme-hint-color:#8E8E93;
      --tg-theme-link-color:#007AFF;--tg-theme-button-color:#007AFF;--tg-theme-button-text-color:#ffffff;
      --tg-theme-secondary-bg-color:#2a2a2a;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--tg-theme-bg-color);color:var(--tg-theme-text-color);padding:16px;min-height:100vh;overflow-x:hidden}
    .container{max-width:600px;margin:0 auto;padding-bottom:100px}
    .header{text-align:center;margin-bottom:24px;padding:20px;background:var(--tg-theme-secondary-bg-color);border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.1)}
    .header h1{font-size:24px;margin-bottom:8px;background:linear-gradient(135deg,var(--tg-theme-button-color),#34C759);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header p{color:var(--tg-theme-hint-color);font-size:14px}
    .sync-status{background:rgba(52,199,89,.1);border:1px solid rgba(52,199,89,.3);color:#34C759;padding:8px 12px;border-radius:8px;font-size:12px;margin-top:10px;display:none}
    .sync-status.syncing{background:rgba(255,149,0,.1);border-color:rgba(255,149,0,.3);color:#FF9500;display:block}
    .sync-status.error{background:rgba(255,59,48,.1);border-color:rgba(255,59,48,.3);color:#FF3B30;display:block}
    .sync-status.synced{display:block}
    .form-section{background:var(--tg-theme-secondary-bg-color);border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 2px 12px rgba(0,0,0,.1)}
    .form-section h2{margin-bottom:16px;font-size:18px}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;font-size:14px}
    .form-group input,.form-group textarea{width:100%;padding:12px 16px;border:2px solid transparent;border-radius:12px;font-size:16px;background:var(--tg-theme-bg-color);color:var(--tg-theme-text-color);transition:all .3s;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .form-group input:focus,.form-group textarea:focus{outline:none;border-color:var(--tg-theme-button-color);box-shadow:0 0 0 3px rgba(0,122,255,.1);transform:translateY(-1px)}
    .btn{background:linear-gradient(135deg,var(--tg-theme-button-color),#34C759);color:var(--tg-theme-button-text-color);border:none;padding:16px 24px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;width:100%;transition:all .3s;box-shadow:0 4px 16px rgba(0,122,255,.2)}
    .btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,122,255,.3)}
    .deadline-list{margin-top:20px}
    .deadline-item{background:var(--tg-theme-secondary-bg-color);border-radius:16px;padding:16px;margin-bottom:12px;border-left:4px solid var(--tg-theme-button-color);transition:all .3s;box-shadow:0 2px 8px rgba(0,0,0,.1);position:relative;overflow:hidden}
    .deadline-item.overdue{border-left-color:#FF3B30;background:linear-gradient(135deg,var(--tg-theme-secondary-bg-color),rgba(255,59,48,.05))}
    .deadline-item.today{border-left-color:#FF9500;background:linear-gradient(135deg,var(--tg-theme-secondary-bg-color),rgba(255,149,0,.05))}
    .deadline-item.urgent{border-left-color:#FFCC00;background:linear-gradient(135deg,var(--tg-theme-secondary-bg-color),rgba(255,204,0,.05))}
    .deadline-item.soon{border-left-color:#34C759;background:linear-gradient(135deg,var(--tg-theme-secondary-bg-color),rgba(52,199,89,.05))}
    .deadline-item.planned{border-left-color:var(--tg-theme-button-color);background:linear-gradient(135deg,var(--tg-theme-secondary-bg-color),rgba(0,122,255,.05))}
    .deadline-title{font-size:16px;font-weight:600;margin-bottom:8px;line-height:1.3}
    .deadline-date{color:var(--tg-theme-hint-color);margin-bottom:4px;font-size:13px;display:flex;align-items:center;gap:4px}
    .deadline-status{display:inline-block;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}
    .status-overdue{background:linear-gradient(135deg,#FF3B30,#FF6B6B);color:#fff}
    .status-today{background:linear-gradient(135deg,#FF9500,#FFA726);color:#fff}
    .status-urgent{background:linear-gradient(135deg,#FFCC00,#FFD54F);color:#2C2C2E}
    .status-soon{background:linear-gradient(135deg,#34C759,#4CAF50);color:#fff}
    .status-planned{background:linear-gradient(135deg,var(--tg-theme-button-color),#42A5F5);color:#fff}
    .complete-btn{background:linear-gradient(135deg,#34C759,#4CAF50);color:#fff;border:none;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;transition:all .3s;box-shadow:0 2px 8px rgba(52,199,89,.2)}
    .message{padding:16px;border-radius:12px;margin-bottom:16px;font-weight:500;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .message.success{background:linear-gradient(135deg,rgba(52,199,89,.1),rgba(52,199,89,.05));border:1px solid rgba(52,199,89,.3);color:#34C759}
    .message.error{background:linear-gradient(135deg,rgba(255,59,48,.1),rgba(255,59,48,.05));border:1px solid rgba(255,59,48,.3);color:#FF3B30}
    .empty-state{text-align:center;padding:40px 20px;color:var(--tg-theme-hint-color);background:var(--tg-theme-secondary-bg-color);border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:12px;margin-bottom:20px}
    .stat-item{background:var(--tg-theme-secondary-bg-color);border-radius:16px;padding:16px 12px;text-align:center;transition:all .3s;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.1);position:relative;overflow:hidden}
    .stat-number{font-size:24px;font-weight:700;margin-bottom:6px}
    .fab{position:fixed;bottom:20px;right:20px;width:56px;height:56px;background:linear-gradient(135deg,var(--tg-theme-button-color),#34C759);color:#fff;border:none;border-radius:50%;font-size:24px;cursor:pointer;box-shadow:0 4px 16px rgba(0,122,255,.3);transition:all .3s;z-index:100;display:none;align-items:center;justify-content:center}
    .fab.show{display:flex}
    .loading{display:none;text-align:center;padding:40px;color:var(--tg-theme-hint-color)}
    .loading.show{display:block}
    .loading-spinner{width:40px;height:40px;border:3px solid var(--tg-theme-hint-color);border-top:3px solid var(--tg-theme-button-color);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìÖ Deadline Manager</h1>
      <p id="timezone-info">Moscow Time (UTC+3) ‚Ä¢ Telegram Mini App</p>
      <div id="sync-status" class="sync-status">üîÑ Synced</div>
    </div>

    <div id="message-container"></div>

    <div id="loading" class="loading show">
      <div class="loading-spinner"></div>
      <p>Loading your deadlines...</p>
    </div>

    <div class="form-section">
      <h2>‚ûï Add New Deadline</h2>
      <form id="deadline-form">
        <div class="form-group">
          <label for="task-title">üìù Task Title</label>
          <input id="task-title" type="text" placeholder="What needs to be done?" required maxlength="100">
        </div>
        <div class="form-group">
          <label for="task-date">üìÖ Due Date & Time</label>
          <input id="task-date" type="datetime-local" required>
        </div>
        <div class="form-group">
          <label for="task-description">üìÑ Description (Optional)</label>
          <textarea id="task-description" rows="3" maxlength="300" placeholder="Add details..."></textarea>
        </div>
        <button type="submit" class="btn"><span>‚ú® Add Deadline</span></button>
      </form>
    </div>

    <div class="stats" id="stats-container" style="display:none;">
      <div class="stat-item" onclick="filterByStatus('all')">
        <div class="stat-number" id="total-count">0</div><div class="stat-label">Total</div>
      </div>
      <div class="stat-item" onclick="filterByStatus('overdue')">
        <div class="stat-number" id="overdue-count">0</div><div class="stat-label">Overdue</div>
      </div>
      <div class="stat-item" onclick="filterByStatus('today')">
        <div class="stat-number" id="today-count">0</div><div class="stat-label">Due Today</div>
      </div>
      <div class="stat-item" onclick="filterByStatus('urgent')">
        <div class="stat-number" id="urgent-count">0</div><div class="stat-label">Urgent</div>
      </div>
    </div>

    <div class="deadline-list">
      <h2 id="list-title">üìã Your Deadlines</h2>
      <div id="deadlines-container">
        <div class="empty-state">
          <div style="font-size:48px;opacity:.6;margin-bottom:16px;">üìù</div>
          <h3>No deadlines yet</h3>
          <p>Add your first deadline using the form above to get started!</p>
        </div>
      </div>
    </div>
  </div>

  <button class="fab" id="fab" onclick="scrollToForm()">‚ûï</button>

  <script>
    // ========= CONFIG =========
    const API_BASE = "https://boodeyman.ru";

    // ========= Telegram =========
    let tg = window.Telegram?.WebApp;
    let user_id = null;
    let syncEnabled = false;
    let currentFilter = 'all';

    const syncStatus = document.getElementById('sync-status');
    const messageContainer = document.getElementById('message-container');
    const loading = document.getElementById('loading');
    const statsContainer = document.getElementById('stats-container');
    const container = document.getElementById('deadlines-container');
    const listTitle = document.getElementById('list-title');
    const fab = document.getElementById('fab');

    if (tg) {
      tg.ready(); tg.expand();
      user_id = tg.initDataUnsafe?.user?.id?.toString();
      syncEnabled = !!user_id;

      const themeParams = tg.themeParams;
      if (themeParams) {
        setCSS('--tg-theme-bg-color', themeParams.bg_color || '#1a1a1a');
        setCSS('--tg-theme-text-color', themeParams.text_color || '#ffffff');
        setCSS('--tg-theme-button-color', themeParams.button_color || '#007AFF');
        setCSS('--tg-theme-button-text-color', themeParams.button_text_color || '#ffffff');
        setCSS('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color || '#2a2a2a');
        setCSS('--tg-theme-hint-color', themeParams.hint_color || '#8E8E93');
      }

      tg.BackButton.onClick(() => tg.close());
      tg.BackButton.show();
      tg.MainButton.setText("Quick Add Deadline");
      tg.MainButton.onClick(() => { scrollToForm(); document.getElementById('task-title').focus(); });

      syncStatus.style.display = 'block';
    } else {
      user_id = 'demo_' + Math.random().toString(36).slice(2,9);
      syncEnabled = false;
    }

    // ========= State =========
    let deadlines = [];
    let nextId = 1;

    // ========= Init =========
    init();

    function init(){
      setDefaultDate();
      if (syncEnabled) {
        requestBotData().then(()=>{ setup(); render(); hideLoading(); });
      } else {
        loadLocalData(); setup(); render(); hideLoading();
      }
    }

    function setup(){
      const form = document.getElementById('deadline-form');
      form.addEventListener('submit', handleSubmit);
      document.getElementById('task-title').addEventListener('input', debounce(autoSave, 800));
      document.getElementById('task-description').addEventListener('input', debounce(autoSave, 800));
      window.addEventListener('scroll', handleScroll);
      window.addEventListener('load', loadDraft);
      setInterval(updateClockAndRerender, 60000);
      initGestures();
      setTimeout(initializeHelp, 800);
      setupScrollFab();
    }

    // ========= PULL =========
    async function requestBotData(){
      try {
        setSync('Loading from bot...', 'syncing');
        const res = await fetch(`${API_BASE}/api/deadlines`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ initData: tg.initData })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'api_error');

        deadlines = (json.deadlines || []).map(d => ({
          ...d,
          date: new Date(d.date),
          created: d.created ? new Date(d.created) : new Date()
        }));
        nextId = json.next_id || (deadlines.reduce((m,d)=>Math.max(m, d.id||0),0)+1);
        saveLocalData();

        setSync('Connected to bot database', 'synced');
        setTimeout(()=>setSync('üîÑ Synced',''), 1500);
      } catch (e) {
        console.error('Pull error:', e);
        setSync('Sync error ‚Äî local cache in use', 'error');
        loadLocalData();
      }
    }

    // ========= PUSH =========
    function syncToBot(action, data=null){
      if (!syncEnabled || !tg) return;
      const payload = { action, timestamp: new Date().toISOString(), user_id };
      if (action === 'add_deadline'){
        payload.data = { title:data.title, date:data.date.toISOString(), description:data.description, id:data.id };
      } else if (action === 'complete_deadline'){
        payload.deadline_id = data.id; payload.title = data.title;
      } else if (action === 'sync_deadlines'){
        payload.deadlines = data;
      }
      tg.sendData(JSON.stringify(payload));
      setSync('Synced to bot','synced');
      setTimeout(()=>setSync('üîÑ Synced',''), 1200);
    }

    // ========= Form =========
    function handleSubmit(e){
      e.preventDefault();
      const title = val('#task-title').trim();
      const dateValue = val('#task-date');
      const description = val('#task-description').trim();

      if (!title) return showMessage('Please enter a task title','error');
      if (title.length>100) return showMessage('Task title is too long (max 100)','error');
      if (!dateValue) return showMessage('Please select a due date','error');
      if (description.length>300) return showMessage('Description too long (max 300)','error');

      const deadline = {
        id: nextId++,
        title,
        date: new Date(dateValue),
        description,
        created: new Date(),
        user_id
      };
      deadlines.push(deadline); saveLocalData();
      syncToBot('add_deadline', deadline);

      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

      e.target.reset(); setDefaultDate(); render();
      showMessage(`"${title}" added and synced! üéâ`, 'success'); clearAutoSave();
      bounceButton(e.target.querySelector('.btn'));
    }

    function completeDeadline(id){
      const d = deadlines.find(x=>x.id===id);
      if (!d) return;
      deadlines = deadlines.filter(x=>x.id!==id);
      saveLocalData(); syncToBot('complete_deadline', d);
      if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
      render(); showMessage(`"${d.title}" completed and synced! üéâ`, 'success');
      if (deadlines.length===0){ setTimeout(()=>showMessage("üèÜ All tasks completed! You're amazing! üéä",'success'), 800); }
    }
    window.completeDeadline = completeDeadline;

    // ========= Filters / Stats / Render =========
    function filterByStatus(status){
      currentFilter = status; render();
      const titles = { all:'üìã Your Deadlines', overdue:'üî¥ Overdue Deadlines', today:'üü† Due Today', urgent:'üü° Urgent Deadlines' };
      document.getElementById('list-title').textContent = titles[status] || 'üìã Your Deadlines';
      if (tg?.HapticFeedback) tg.HapticFeedback.selectionChanged();
    }
    window.filterByStatus = filterByStatus;

    function render(){
      renderDeadlines();
      updateStats();
      updateMainButton();
    }

    function renderDeadlines(){
      let filtered = deadlines;
      if (currentFilter!=='all') filtered = deadlines.filter(d => getStatus(d)===currentFilter);

      if (filtered.length===0){
        const isFiltered = currentFilter!=='all';
        const map = {
          all: { icon:'üìù', title:'No deadlines yet', text:'Add your first deadline using the form above!' },
          overdue: { icon:'‚úÖ', title:'No overdue tasks!', text:'Great job staying on top!' },
          today: { icon:'üéØ', title:'Nothing due today!', text:'You can relax or work on upcoming tasks.' },
          urgent: { icon:'üåü', title:'No urgent tasks!', text:'All your deadlines are well-scheduled.' }
        };
        const m = map[currentFilter] || map.all;
        container.innerHTML = `
          <div class="empty-state">
            <div style="font-size:48px;opacity:.6;margin-bottom:16px;">${m.icon}</div>
            <h3>${m.title}</h3><p>${m.text}</p>
            ${isFiltered ? '<button onclick="filterByStatus(\'all\')" class="btn" style="margin-top: 16px; width:auto; padding:8px 16px;">Show All Deadlines</button>' : ''}
          </div>`;
        return;
      }

      const sorted = [...filtered].sort((a,b)=>new Date(a.date)-new Date(b.date));
      container.innerHTML = sorted.map(d=>{
        const status = getStatus(d);
        const statusText = getStatusText(status);
        const timeLeft = getTimeLeft(d);
        return `
          <div class="deadline-item ${status}" data-id="${d.id}">
            <div class="deadline-title">${escapeHtml(d.title)}</div>
            <div class="deadline-date">üìÖ ${formatDate(d.date)}</div>
            <div class="deadline-date">‚è∞ ${timeLeft}</div>
            <div class="deadline-status status-${status}">${statusText}</div>
            ${d.description ? `<div class="deadline-date">üìù ${escapeHtml(d.description)}</div>` : ''}
            <button class="complete-btn" onclick="completeDeadline(${d.id})">‚úÖ Complete & Remove</button>
          </div>`;
      }).join('');
    }

    function updateStats(){
      const stats = {
        total: deadlines.length,
        overdue: deadlines.filter(d=>getStatus(d)==='overdue').length,
        today: deadlines.filter(d=>getStatus(d)==='today').length,
        urgent: deadlines.filter(d=>getStatus(d)==='urgent').length
      };
      text('#total-count', stats.total);
      text('#overdue-count', stats.overdue);
      text('#today-count', stats.today);
      text('#urgent-count', stats.urgent);
      statsContainer.style.display = stats.total>0 ? 'grid' : 'none';
    }

    function updateMainButton(){
      if (!tg) return;
      const s = {
        overdue: deadlines.filter(d=>getStatus(d)==='overdue').length,
        today: deadlines.filter(d=>getStatus(d)==='today').length,
        urgent: deadlines.filter(d=>getStatus(d)==='urgent').length
      };
      const urgentTotal = s.overdue + s.today + s.urgent;
      if (urgentTotal>0){
        tg.MainButton.setText(`‚ö° ${urgentTotal} Urgent Task${urgentTotal===1?'':'s'}`); tg.MainButton.color='#FF3B30'; tg.MainButton.show();
      } else if (deadlines.length>0){
        tg.MainButton.setText("‚ú® Add New Deadline"); tg.MainButton.color = tg.themeParams?.button_color || '#007AFF'; tg.MainButton.show();
      } else {
        tg.MainButton.setText("üöÄ Add Your First Deadline"); tg.MainButton.color = '#34C759'; tg.MainButton.show();
      }
    }

    // ========= Data Utils =========
    function saveLocalData(){
      const data = {
        deadlines: deadlines.map(d=>({...d, date:d.date.toISOString(), created:d.created.toISOString()})),
        nextId, user_id, savedAt: new Date().toISOString(), version: '2.0'
      };
      try { sessionStorage.setItem(`deadlineData_${user_id}`, JSON.stringify(data)); } catch {}
    }
    function loadLocalData(){
      try {
        const raw = sessionStorage.getItem(`deadlineData_${user_id}`); if (!raw) return;
        const data = JSON.parse(raw);
        if (data.user_id===user_id && data.version==='2.0'){
          deadlines = data.deadlines.map(d=>({...d, date:new Date(d.date), created:new Date(d.created)}));
          nextId = data.nextId || 1;
        }
      } catch {}
    }

    // ========= Helpers =========
    function setCSS(name, value){ document.documentElement.style.setProperty(name, value); }
    function val(sel){ return document.querySelector(sel).value; }
    function text(sel, v){ const el=document.querySelector(sel); if (el) el.textContent=v; }
    function setSync(message, type){ syncStatus.textContent = message; syncStatus.className = `sync-status ${type||''}`; }
    function hideLoading(){ setTimeout(()=>loading.classList.remove('show'), 500); }
    function setDefaultDate(){
      const now = new Date(); now.setHours(now.getHours()+1,0,0,0);
      const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
      const hh=String(now.getHours()).padStart(2,'0'), mm=String(now.getMinutes()).padStart(2,'0');
      document.getElementById('task-date').value = `${y}-${m}-${d}T${hh}:${mm}`;
    }
    function getStatus(d){
      const now=new Date(), due=new Date(d.date);
      if (due<now) return 'overdue';
      if (now.toDateString()===due.toDateString()) return 'today';
      const diffDays = Math.ceil((due-now)/86400000);
      if (diffDays<=3) return 'urgent';
      if (diffDays<=7) return 'soon';
      return 'planned';
    }
    function getStatusText(s){ return ({overdue:'OVERDUE',today:'DUE TODAY',urgent:'URGENT',soon:'SOON',planned:'PLANNED'})[s]||'UNKNOWN'; }
    function getTimeLeft(d){
      const now=new Date(), due=new Date(d.date), diff=due-now;
      if (diff<0){
        const days=Math.abs(Math.ceil(diff/86400000)), hours=Math.abs(Math.ceil(diff/3600000));
        if (days>0) return `${days} day${days===1?'':'s'} overdue`;
        if (hours>0) return `${hours} hour${hours===1?'':'s'} overdue`;
        return 'Just overdue';
      }
      const days=Math.ceil(diff/86400000), hours=Math.ceil(diff/3600000);
      if (days===0) return hours>1?`${hours} hours left`:`${hours} hour left`;
      return days===1?'1 day left':`${days} days left`;
    }
    function formatDate(date){
      return new Date(date).toLocaleString('en-US', {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:false});
    }
    function showMessage(text, type){
      const div=document.createElement('div'); div.className=`message ${type}`; div.textContent=text;
      messageContainer.appendChild(div);
      setTimeout(()=>{ div.style.opacity='0'; setTimeout(()=>div.remove(), 300); }, 4000);
    }
    function bounceButton(btn){ if(!btn) return; btn.classList.add('bounce'); setTimeout(()=>btn.classList.remove('bounce'), 800); }

    // ========= Draft autosave =========
    function autoSave(){
      const title = document.getElementById('task-title').value.trim();
      const description = document.getElementById('task-description').value.trim();
      if (title || description){
        try { sessionStorage.setItem(`draft_${user_id}`, JSON.stringify({title, description, ts: Date.now()})); } catch {}
      }
    }
    function loadDraft(){
      try {
        const raw = sessionStorage.getItem(`draft_${user_id}`); if (!raw) return;
        const d = JSON.parse(raw);
        if (Date.now()-d.ts < 60*60*1000){
          document.getElementById('task-title').value = d.title || '';
          document.getElementById('task-description').value = d.description || '';
          if (d.title || d.description) showMessage('üìù Draft restored', 'success');
        }
      } catch {}
    }
    function clearAutoSave(){ try{ sessionStorage.removeItem(`draft_${user_id}`) }catch{} }

    // ========= UI niceties =========
    function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
    function escapeHtml(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
    function handleScroll(){ fab.style.display = (window.scrollY > 120) ? 'flex' : 'none'; }
    function setupScrollFab(){
      let last=0; window.addEventListener('scroll', ()=>{
        const s = window.pageYOffset || document.documentElement.scrollTop;
        if (s>200 && s>last) fab.classList.add('show'); else if (s<100) fab.classList.remove('show');
        last = s;
      });
    }
    function scrollToForm(){ document.querySelector('.form-section').scrollIntoView({behavior:'smooth', block:'center'}); setTimeout(()=>document.getElementById('task-title').focus(), 400); }
    function initializeHelp(){
      const titleInput = document.getElementById('task-title');
      const dateInput = document.getElementById('task-date');
      titleInput.addEventListener('focus', ()=>{ if (!titleInput.value) showMessage('üí° Tip: Use clear, actionable titles like "Submit report"', 'success'); });
      dateInput.addEventListener('change', ()=>{
        const sel = new Date(dateInput.value); const now = new Date(); const diffH = (sel-now)/3600000;
        if (diffH<0) showMessage('‚ö†Ô∏è This date is in the past', 'error');
        else if (diffH<1) showMessage('‚ö†Ô∏è This deadline is very soon!', 'error');
      });
    }
    function updateClockAndRerender(){
      const now = new Date();
      document.getElementById('timezone-info').textContent =
        `Moscow Time: ${now.toLocaleString('ru-RU',{ timeZone:'Europe/Moscow', hour:'2-digit', minute:'2-digit' })} ‚Ä¢ Telegram Mini App`;
      if (deadlines.length>0) renderDeadlines();
    }

    // ========= Touch gestures =========
    let tY0 = 0, tY1 = 0;
    function initGestures(){
      document.addEventListener('touchstart', e => { tY0 = e.changedTouches[0].screenY; });
      document.addEventListener('touchend', e => { tY1 = e.changedTouches[0].screenY; handleSwipe(); });
    }
    function handleSwipe(){
      const thr = 50, diff = tY0 - tY1;
      if (Math.abs(diff) > thr){
        if (diff > 0){ if (window.scrollY < 100) scrollToForm(); }
        else { if (window.scrollY < 50){ render(); showMessage('üîÑ Refreshed!', 'success'); } }
      }
    }

  </script>
</body>
</html>
